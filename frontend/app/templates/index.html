<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vision - Plataforma de Processamento de Mídia</title>
    <style>
        :root {
            --primary: #6366f1; --primary-dark: #4f46e5; --secondary: #8b5cf6;
            --success: #10b981; --error: #ef4444; --gray-50: #f9fafb;
            --gray-100: #f3f4f6; --gray-200: #e5e7eb; --gray-700: #374151;
            --gray-900: #111827;
        }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background-color: var(--gray-100); color: var(--gray-700); margin: 0; line-height: 1.6; }
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 2rem; }
        .header { text-align: center; margin-bottom: 4rem; }
        .header h1 { font-size: 3rem; font-weight: 800; background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .header p { font-size: 1.125rem; color: #4b5563; margin-top: 0.5rem; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; }
        .tool-card { background: white; border-radius: 16px; padding: 2rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid var(--gray-200); cursor: pointer; transition: all 0.3s ease; text-align: center; display: flex; flex-direction: column; }
        .tool-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .tool-card .icon { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border-radius: 50%; width: 64px; height: 64px; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem auto; flex-shrink: 0; }
        .tool-card .icon svg { width: 32px; height: 32px; }
        .tool-card h2 { font-size: 1.5rem; color: var(--gray-900); margin-bottom: 0.5rem; }
        .tool-card p { font-size: 1rem; color: #4b5563; flex-grow: 1; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(17, 24, 39, 0.6); backdrop-filter: blur(5px); align-items: center; justify-content: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 2rem; border: 1px solid var(--gray-200); width: 90%; max-width: 500px; border-radius: 16px; position: relative; animation: slide-down 0.3s ease-out; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        .close-btn { color: #aaa; position: absolute; top: 1rem; right: 1.5rem; font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal h2 { margin-top: 0; color: var(--gray-900); }
        label { display: block; font-weight: 500; margin-bottom: 0.5rem; }
        input[type="file"], input[type="number"], select { width: 100%; padding: 0.75rem; margin-bottom: 1.5rem; border: 1px solid var(--gray-200); border-radius: 8px; font-size: 1rem; }
        .btn { width: 100%; padding: 0.8rem; border: none; border-radius: 8px; color: white; background: var(--primary); font-size: 1rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
        .btn:hover { background: var(--primary-dark); }
        .btn:disabled { background-color: #9ca3af; cursor: not-allowed; }
        .terminal { margin-top: 1.5rem; background: var(--gray-900); color: #e5e7eb; border-radius: 8px; padding: 1rem; font-family: 'SF Mono', 'Consolas', monospace; font-size: 0.9rem; height: 150px; overflow-y: auto; white-space: pre-wrap; border: 1px solid #374151; }
        .download-link { color: var(--success); font-weight: bold; text-decoration: none; border-bottom: 2px solid var(--success); }
        @keyframes slide-down { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Plataforma Vision</h1>
            <p>A sua caixa de ferramentas para processamento de mídia na nuvem.</p>
        </header>

        <main>
            <div class="grid">
                <div class="tool-card" data-modal="image-modal">
                    <div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21.92,12.38A1,1,0,0,0,21,12H19.41A8,8,0,0,0,12,4.59V3a1,1,0,0,0-2,0V4.59A8,8,0,0,0,4.59,12H3a1,1,0,0,0,0,2H4.59A8,8,0,0,0,12,19.41V21a1,1,0,0,0,2,0V19.41A8,8,0,0,0,19.41,14H21a1,1,0,0,0,.92-1.62ZM12,18a6,6,0,1,1,6-6A6,6,0,0,1,12,18Z"/></svg></div>
                    <h2>Ferramentas de Imagem</h2>
                    <p>Converta formatos e aplique filtros como Preto & Branco ou Sépia.</p>
                </div>
                <div class="tool-card" data-modal="video-modal">
                    <div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20.5,15.6V8.4a1,1,0,0,0-1.55-.83L15,9.85V6A2,2,0,0,0,13,4H4A2,2,0,0,0,2,6v12a2,2,0,0,0,2,2h9a2,2,0,0,0,2-2V14.15l3.95,2.08A1,1,0,0,0,20.5,15.6Z"/></svg></div>
                    <h2>Ferramentas de Vídeo</h2>
                    <p>Converta vídeos para MP4 e extraia thumbnails.</p>
                </div>
                <div class="tool-card" data-modal="slideshow-modal">
                    <div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19,2H5A3,3,0,0,0,2,5V19a3,3,0,0,0,3,3H19a3,3,0,0,0,3-3V5A3,3,0,0,0,19,2ZM8,14.5,5,18H19l-4-6-3.5,4.5ZM5,4H19a1,1,0,0,1,1,1V15.35L17.5,13,14,9.5,10.5,14,8.5,11.5,5,15.5Z"/></svg></div>
                    <h2>Criador de Slideshow</h2>
                    <p>Crie um vídeo a partir de uma coleção de imagens.</p>
                </div>
                <div class="tool-card" data-modal="pdf-modal">
                    <div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20,8.55V20a2,2,0,0,1-2,2H6a2,2,0,0,1-2-2V4A2,2,0,0,1,6,2h8.59a1,1,0,0,1,.7.29l4.42,4.42A1,1,0,0,1,20,8.55ZM18,9h-4.5A1.5,1.5,0,0,1,12,7.5V3H6V20H18ZM8,14a1,1,0,0,0,0,2h8a1,1,0,0,0,0-2Z"/></svg></div>
                    <h2>Ferramentas de Documento</h2>
                    <p>Junte múltiplos ficheiros PDF num só ou converta-os para imagem.</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal para Ferramentas de Imagem -->
    <div id="image-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Ferramentas de Imagem</h2>
            <form>
                <label for="image-op">Operação:</label>
                <select name="operation" id="image-op" required>
                    <option value="img_to_bw">Converter para Preto e Branco</option>
                    <option value="img_to_sepia">Aplicar Filtro Sépia</option>
                </select>
                <label for="image-file">Ficheiro (PNG, JPG, etc.):</label>
                <input type="file" name="file" id="image-file" accept="image/*" required>
                <button type="submit" class="btn">Processar Imagem</button>
            </form>
            <div class="terminal">Aguardando envio...</div>
        </div>
    </div>
    
    <!-- Modal para Ferramentas de Vídeo -->
    <div id="video-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Ferramentas de Vídeo</h2>
            <form>
                <label for="video-op">Operação:</label>
                <select name="operation" id="video-op" required>
                    <option value="video_to_mp4">Converter para MP4</option>
                    <option value="generate_thumbnail">Gerar Thumbnail (do segundo 2)</option>
                </select>
                <label for="video-file">Ficheiro de Vídeo:</label>
                <input type="file" name="file" id="video-file" accept="video/*" required>
                <button type="submit" class="btn">Processar Vídeo</button>
            </form>
            <div class="terminal">Aguardando envio...</div>
        </div>
    </div>

    <!-- Modal para Criador de Slideshow -->
    <div id="slideshow-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Criador de Slideshow</h2>
            <form>
                <input type="hidden" name="operation" value="create_slideshow">
                <label for="slideshow-files">Imagens (Envie um ficheiro .ZIP com as imagens):</label>
                <input type="file" name="file" id="slideshow-files" accept=".zip" required>
                <label for="slide-duration">Duração de cada imagem (segundos):</label>
                <input type="number" name="params" id="slide-duration" value="3" min="1" required>
                <button type="submit" class="btn">Criar Slideshow</button>
            </form>
            <div class="terminal">Aguardando envio...</div>
        </div>
    </div>

    <!-- Modal para Ferramentas de PDF -->
    <div id="pdf-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Ferramentas de Documento</h2>
            <form>
                 <label for="pdf-op">Operação:</label>
                <select name="operation" id="pdf-op" required>
                    <option value="pdf_to_images">Converter PDF para Imagens (ZIP)</option>
                    <option value="merge_pdfs">Juntar PDFs (Envie um ZIP)</option>
                </select>
                <label for="pdf-file">Ficheiro PDF ou ZIP:</label>
                <input type="file" name="file" id="pdf-file" accept=".pdf,.zip" required>
                <button type="submit" class="btn">Processar Documento</button>
            </form>
            <div class="terminal">Aguardando envio...</div>
        </div>
    </div>
    
    <script>
        // Lógica para abrir e fechar modais
        const toolCards = document.querySelectorAll('.tool-card');
        const closeBtns = document.querySelectorAll('.close-btn');

        toolCards.forEach(card => {
            card.addEventListener('click', () => {
                document.getElementById(card.dataset.modal).style.display = 'flex';
            });
        });

        const closeModal = (modal) => {
            modal.style.display = 'none';
            const form = modal.querySelector('form');
            if(form) {
                form.reset();
                const terminal = form.nextElementSibling;
                terminal.innerHTML = 'Aguardando envio...';
                form.querySelector('button').disabled = false;
                form.querySelector('button').textContent = 'Processar'; 
            }
        };
        closeBtns.forEach(btn => btn.addEventListener('click', () => closeModal(btn.closest('.modal'))));
        window.addEventListener('click', (event) => {
            if (event.target.classList.contains('modal')) closeModal(event.target);
        });

        // Lógica de Submissão de Formulário
        document.querySelectorAll('form').forEach(form => {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = form.querySelector('button');
                const terminal = form.nextElementSibling;
                
                const fileInput = form.querySelector('input[type="file"]');
                if (!fileInput.files[0]) {
                    terminal.textContent = 'Erro: Por favor, selecione um ficheiro.';
                    return;
                }
                
                const originalBtnText = btn.textContent;
                btn.disabled = true;
                btn.textContent = 'A enviar...';
                terminal.textContent = 'A enviar ficheiro(s) para o armazenamento...';
                
                const formData = new FormData(form);

                try {
                    const response = await fetch('/upload', { method: 'POST', body: formData });
                    const result = await response.json();

                    if (!response.ok) throw new Error(result.error || 'Erro desconhecido no upload.');

                    terminal.textContent = `Ficheiro enviado! ID do trabalho: ${result.jobId}\nA aguardar processamento...`;
                    pollForStatus(result.jobId, terminal, btn, originalBtnText);

                } catch (error) {
                    terminal.textContent = `Erro no envio: ${error.message}`;
                    btn.disabled = false;
                    btn.textContent = originalBtnText;
                }
            });
        });

        function pollForStatus(jobId, terminal, btn, originalBtnText) {
            const intervalId = setInterval(async () => {
                try {
                    const response = await fetch(`/status/${jobId}`);
                    const data = await response.json();
                    
                    if (!response.ok) throw new Error(data.error || "Erro de servidor");
                    
                    terminal.textContent = `A verificar... (Estado atual: ${data.status || 'pendente'})`;

                    if (data.status === 'completed') {
                        clearInterval(intervalId);
                        terminal.innerHTML = `Processamento concluído!<br><a href="${data.outputUrl}" target="_blank" class="download-link">Descarregar Ficheiro</a>`;
                        btn.disabled = false;
                        btn.textContent = 'Processar Outro';
                    } else if (data.status === 'failed') {
                        clearInterval(intervalId);
                        terminal.textContent = `Falha no processamento: ${data.errorMessage}`;
                        btn.disabled = false;
                        btn.textContent = 'Tentar Novamente';
                    }
                } catch (error) {
                    clearInterval(intervalId);
                    terminal.textContent = 'Erro de conexão ao verificar o estado do trabalho.';
                }
            }, 5000); // Verifica a cada 5 segundos
        }
    </script>
</body>
</html>
